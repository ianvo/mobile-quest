
<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Test Room</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

        <script src="socket.io.js"></script>
        <script src="phaser.min.js" type="text/javascript"></script>
        <script src="vjoy.js"></script>
        <script src="footprints.js" type="text/javascript"></script>
        <script src="player.js" type="text/javascript"></script>
        <style>
            body {
                margin: 0px;
                padding: 0px;
                font-family: Arial;
                font-size: 14px;
                background-color: #000000;
                color: #fff;
            }
        </style>
    </head>
    <body>
        <div id="phaser-example"></div>

        <script type="text/javascript">

        
    var socket = io();
    
    var name = prompt("Enter your name", "Anon");
    if(name) {
        var game = new Phaser.Game('100%', '100%', Phaser.CANVAS, 'phaser-example', { preload: preload, init:init, create: create, update: update, render: render });
    }


function preload() {

    //game.load.tilemap('map', 'catastrophi_level2.csv', null, Phaser.Tilemap.CSV);
    //game.load.image('tiles', 'catastrophi_tiles_16.png');
    game.load.tilemap('map', 'world.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.spritesheet('tileset', 'tilesheet.png',32,32);
    game.load.spritesheet('player', 'sprite_melee.png', 64, 64);
    game.load.spritesheet('chat_button', 'chat_button.png', 134, 40);
    game.load.image('footprints', 'footprints.png');
    
    game.load.image('vjoy_base', 'base.png');
    game.load.image('vjoy_body', 'body.png');
    game.load.image('vjoy_cap', 'cap.png');

}

var map;
var layer;
var pad;
var stick;
var buttonA;
var collisionLayer;
var aboveLayer;
var buildingsLayer;
var objectsLayer;
var flowersLayer;
var baseLayer;

var playerId = undefined;
var players = {};
var footprints = [];
var wasd;

function init() {
    game.renderer.renderSession.roundPixels = true;
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.stage.disableVisibilityChange = true;
}

function create() {

    
    map = game.add.tilemap('map');
    map.addTilesetImage('tilesheet', 'tileset');
    
    baseLayer = map.createLayer('base');
    flowersLayer = map.createLayer('flowers');
    objectsLayer = map.createLayer('objects');
    buildingsLayer = map.createLayer('buildings');
    aboveLayer = map.createLayer('above');
    collisionLayer = map.createLayer('collisions');
    collisionLayer.alpha=0;
    game.physics.arcade.enable(collisionLayer);
    game.add.existing(collisionLayer);
    map.setCollisionByExclusion([0], true, collisionLayer);
    aboveLayer.resizeWorld();

    button = game.add.button(game.width - 150, game.height-130, 'chat_button', openChat, this, 0, 0, 1, 0);
    button.fixedToCamera = true;

    pad = game.plugins.add(Phaser.Plugin.VJoy);
    pad.inputEnable(pad.settings.maxDistanceInPixels+40, game.height-(pad.settings.maxDistanceInPixels+60));
    socket.emit('createPlayer', name);

    wasd = {
          up: game.input.keyboard.addKey(Phaser.Keyboard.W),
          down: game.input.keyboard.addKey(Phaser.Keyboard.S),
          left: game.input.keyboard.addKey(Phaser.Keyboard.A),
          right: game.input.keyboard.addKey(Phaser.Keyboard.D),
    };

}

function openChat() {
    var message = prompt("Enter your message", "");
    if(message) {
        socket.emit('message', message);
    }
}

socket.on('init', function(initPlayer){
    playerId = initPlayer.id;
    players[playerId] = new Player(game, initPlayer.n, true, initPlayer.x, initPlayer.y);
});

socket.on('allplayers', function(allPlayers){
    for(var i in allPlayers) {
        var player = allPlayers[i];

        if(playerId != i) {
            console.log(JSON.stringify(player));
            players[i] = new Player(game, player.n, false, player.x, player.y);
        }
    }
});

socket.on('newPlayer', function(newPlayer){
    if(newPlayer.id != playerId) {
        players[newPlayer.id] = new Player(game, newPlayer.n, false, newPlayer.x, newPlayer.y);
    }
});

socket.on('playerQuit', function(player) {
    if(players[player] != undefined) {
        players[player].remove();
        delete players[player];
    }
});

socket.on('message', function(message) {
    if(players[message.id] != undefined) {
        players[message.id].setMessage(message.m);
    }
});

socket.on('updatePositions', function(updatePlayers) {
    //console.log(JSON.stringify(updatePlayers));
    for(var i in updatePlayers) {
        var player = updatePlayers[i];

        if(playerId != i && players[i] != undefined) {
            if(player.x != players[i].entity.body.x && player.y != players[i].entity.body.y) {
                players[i].setTarget(player.x, player.y);
            }
            players[i].isMoving = player.isMoving;
        }
    }
});

function update() {
    var dt = game.time.elapsed;
    var me = undefined;
    var rotation = pad.rotation;
    var force = pad.isDown ? 1 : 0;
    if(wasd.up.isDown) {
        force = 1;
        if(wasd.left.isDown) {
            rotation = -Math.PI*3/4;
        }
        else if(wasd.right.isDown) {
            rotation = -Math.PI/4;
        }
        else {
            rotation = -Math.PI/2;
        }
    }
    else if(wasd.down.isDown) {
        force = 1;
        if(wasd.left.isDown) {
            rotation = Math.PI*3/4;
        }   
        else if (wasd.right.isDown) {
            rotation = Math.PI/4;
        }
        else {
            rotation = Math.PI/2;
        }
    }
    else if (wasd.left.isDown) {
        force = 1;
        rotation = Math.PI;
    }
    else if (wasd.right.isDown) {
        force = 1;
        rotation = 0;
    }

    for(var i in players) {
        player = players[i];
        players[i].update(collisionLayer, rotation, force, dt);

        if(playerId == i) {
            socket.emit('currentPosition', {x:player.entity.body.x, y:player.entity.body.y, isMoving:pad.isDown});
            me = player;
        }
        player.bringToTop();
    }

    if(me != undefined) {
        me.bringToTop();
    }

    var newFootprints = [];
    for(var j in footprints) {
        var footprint = footprints[j];
        footprint.update(dt);
        if(footprint.life < footprint.MAX_LIFE) {
            newFootprints.push(footprint);
        }
        else {
            footprint.remove();
        }
    }
    footprints = newFootprints;
    aboveLayer.bringToTop();
    pad.bringToTop()
}

function render() {

    // game.debug.body(player);
    
}
        
        </script>

    </body>
</html>
